<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOUD Study Dashboard - Understanding US Healthcare & Opioid Treatment</title>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #1d1d1f;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 0;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 50%, #AF52DE 100%);
            color: white;
            padding: 60px 0;
            text-align: center;
            margin-bottom: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 122, 255, 0.15);
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 40px;
            overflow: hidden;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .nav-tab {
            flex: 1;
            padding: 18px 24px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border-bottom: 3px solid transparent;
            color: #666;
            position: relative;
            overflow: hidden;
        }
        
        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent);
            transition: left 0.6s;
        }
        
        .nav-tab:hover::before {
            left: 100%;
        }
        
        .nav-tab:hover {
            background: #f8f9fa;
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #007AFF, #5856D6);
            border-bottom-color: transparent;
            color: white;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            transform: scale(1.02);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 40px;
            overflow: hidden;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }
        
        .card-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .card-header h3 {
            color: #495057;
            font-size: 1.4rem;
            margin-bottom: 5px;
        }
        
        .card-content {
            padding: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #1976d2;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1976d2;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .info-box h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }
        
        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .warning-box h4 {
            color: #f57c00;
            margin-bottom: 10px;
        }
        
        .medication-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .medication-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-top: 4px solid #4caf50;
        }
        
        .medication-card h4 {
            color: #2e7d32;
            margin-bottom: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1976d2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .filter-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-group label {
            font-weight: 500;
            color: #555;
            min-width: 120px;
        }
        
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            min-width: 150px;
        }
        
        .filter-toggle {
            background: #1976d2;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .filter-toggle:hover {
            background: #1565c0;
        }
        
        .study-timeline {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .timeline-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px 0;
        }
        
        .timeline-date {
            font-weight: 600;
            color: #1976d2;
            min-width: 120px;
        }
        
        .location-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .location-item {
            background: #e3f2fd;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.9rem;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .chart-container {
                height: 300px;
            }
            
            .filter-panel {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group label {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>🏥 MOUD Study Dashboard</h1>
            <p>Understanding US Healthcare & Opioid Use Disorder Treatment</p>
        </header>
        
        <!-- Filter Controls -->
        <div class="filter-panel" id="filter-panel">
            <div class="filter-group">
                <label for="date-filter">📅 Time Period:</label>
                <select id="date-filter" onchange="applyFilters()">
                    <option value="all">All Timepoints</option>
                    <option value="baseline">Baseline (Mar 2018+)</option>
                    <option value="3_month">3-Month Follow-up</option>
                    <option value="6_month">6-Month Follow-up</option>
                    <option value="12_month">12-Month Follow-up</option>
                    <option value="18_month">18-Month Final (May 2021)</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="medication-filter">💊 MOUD Medication:</label>
                <select id="medication-filter" onchange="applyFilters()">
                    <option value="all">All Medications</option>
                    <option value="buprenorphine">Buprenorphine</option>
                    <option value="methadone">Methadone</option>
                    <option value="naltrexone">Naltrexone</option>
                </select>
            </div>
            
            <button class="filter-toggle" onclick="toggleFilters()">⚙️ Filters</button>
        </div>
        
        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('overview')">Study Overview</button>
            <button class="nav-tab" onclick="showTab('treatments')">Treatment Outcomes</button>
            <button class="nav-tab" onclick="showTab('healthcare')">Healthcare Impact</button>
            <button class="nav-tab" onclick="showTab('demographics')">Demographics</button>
            <button class="nav-tab" onclick="showTab('education')">Healthcare Context</button>
        </nav>
        
        <!-- Study Overview Tab -->
        <div id="overview" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h3>What is MOUD? Understanding Medications for Opioid Use Disorder</h3>
                </div>
                <div class="card-content">
                    <div class="info-box">
                        <h4>🔬 CDC MOUD Study Overview</h4>
                        <p>This dashboard presents data from a comprehensive longitudinal study by the <strong>CDC National Center for Injury Prevention and Control</strong> tracking <strong id="total-patients">1,974</strong> patients with Opioid Use Disorder (OUD) across 15 US cities from <strong>March 2018 to May 2021</strong>. The study examines how different medications help patients recover and reduce harmful drug use.</p>
                    </div>
                    
                    <div class="study-timeline">
                        <h4>📅 Study Timeline</h4>
                        <div class="timeline-item">
                            <div class="timeline-date">March 2018:</div>
                            <div>Patient recruitment and baseline data collection begins</div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-date">2018-2019:</div>
                            <div>3-month and 6-month follow-up assessments</div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-date">2019-2020:</div>
                            <div>12-month follow-up assessments</div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-date">May 2021:</div>
                            <div>Final 18-month follow-up completion</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h4>📍 Study Locations (15 Cities)</h4>
                        </div>
                        <div class="card-content">
                            <div class="location-grid" id="location-grid">
                                <!-- Locations will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="stats-grid" id="overview-stats">
                        <div class="stat-card">
                            <div class="stat-number" id="stat-patients">1,974</div>
                            <div class="stat-label">Total Patients</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">3+</div>
                            <div class="stat-label">Years Duration</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">15</div>
                            <div class="stat-label">US Cities</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">5</div>
                            <div class="stat-label">Assessment Points</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">53%</div>
                            <div class="stat-label">Completion Rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">3</div>
                            <div class="stat-label">MOUD Medications</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Treatment Outcomes Tab -->
        <div id="treatments" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>Treatment Outcomes Over Time</h3>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="treatmentChart"></canvas>
                    </div>
                    
                    <div class="info-box">
                        <h4>📊 Understanding the Data</h4>
                        <p>This chart shows the percentage of patients receiving each MOUD medication at different time points. Effective treatment typically shows sustained or increased medication adherence alongside reduced opioid use.</p>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3>Opioid Use Reduction</h3>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="opioidUseChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Healthcare Impact Tab -->
        <div id="healthcare" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>Healthcare System Impact</h3>
                </div>
                <div class="card-content">
                    <div class="warning-box">
                        <h4>⚕️ Why This Matters for US Healthcare</h4>
                        <p>Opioid use disorder costs the US healthcare system billions annually through emergency department visits, hospitalizations, and ongoing treatment needs. MOUD treatment can significantly reduce these costs while improving patient outcomes.</p>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="healthcareChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Demographics Tab -->
        <div id="demographics" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>Patient Demographics</h3>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="demographicsChart" style="max-height: 400px;"></canvas>
                    </div>
                    <div id="demographics-summary" style="margin-top: 20px;">
                        <!-- Demographics data will be populated here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Education Tab -->
        <div id="education" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>Understanding MOUD Medications</h3>
                </div>
                <div class="card-content">
                    <div class="medication-grid">
                        <div class="medication-card">
                            <h4>💊 Buprenorphine (Suboxone)</h4>
                            <p><strong>How it works:</strong> Partial opioid agonist that reduces cravings and withdrawal symptoms without producing a "high"</p>
                            <p><strong>Benefits:</strong> Can be prescribed by certified doctors in office settings, lower overdose risk</p>
                            <p><strong>Common brands:</strong> Suboxone, Subutex, Zubsolv</p>
                        </div>
                        
                        <div class="medication-card">
                            <h4>🏥 Methadone</h4>
                            <p><strong>How it works:</strong> Full opioid agonist administered daily at specialized clinics</p>
                            <p><strong>Benefits:</strong> Highly effective for severe addiction, comprehensive support services</p>
                            <p><strong>Considerations:</strong> Requires daily clinic visits, strict regulation</p>
                        </div>
                        
                        <div class="medication-card">
                            <h4>🚫 Naltrexone (Vivitrol)</h4>
                            <p><strong>How it works:</strong> Opioid antagonist that blocks the euphoric effects of opioids</p>
                            <p><strong>Benefits:</strong> Monthly injection option, no potential for misuse</p>
                            <p><strong>Requirements:</strong> Must be opioid-free before starting treatment</p>
                        </div>
                    </div>
                    
                    <div class="info-box">
                        <h4>🏛️ US Healthcare Context</h4>
                        <p>The opioid crisis has become one of the most significant public health challenges in US history. MOUD represents evidence-based treatment that:</p>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>Reduces overdose deaths by 50% or more</li>
                            <li>Decreases criminal activity and incarceration rates</li>
                            <li>Improves employment and social functioning</li>
                            <li>Reduces healthcare costs through fewer emergency interventions</li>
                        </ul>
                    </div>
                    
                    <div class="warning-box">
                        <h4>📈 The Broader Impact</h4>
                        <p>Understanding MOUD outcomes helps policymakers, healthcare providers, and communities make informed decisions about:</p>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>Treatment program funding and expansion</li>
                            <li>Healthcare resource allocation</li>
                            <li>Provider training and certification</li>
                            <li>Insurance coverage policies</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading dashboard data...</p>
        </div>
    </div>
    
    <script>
        let dashboardData = null;
        let charts = {};
        let currentFilters = {
            timepoint: 'all',
            medication: 'all'
        };
        
        // Filter functionality
        function toggleFilters() {
            const panel = document.getElementById('filter-panel');
            panel.style.display = panel.style.display === 'none' ? 'flex' : 'none';
        }
        
        function applyFilters() {
            currentFilters.timepoint = document.getElementById('date-filter').value;
            currentFilters.medication = document.getElementById('medication-filter').value;
            
            // Refresh charts with filtered data
            refreshCharts();
        }
        
        function refreshCharts() {
            // Destroy existing charts
            Object.values(charts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            charts = {};
            
            // Recreate charts with current filters
            const activeTab = document.querySelector('.tab-content.active').id;
            setTimeout(() => {
                if (activeTab === 'treatments') {
                    initializeTreatmentCharts();
                } else if (activeTab === 'healthcare') {
                    initializeHealthcareChart();
                } else if (activeTab === 'demographics') {
                    initializeDemographicsChart();
                }
            }, 100);
        }
        
        // Show/hide tabs
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked nav tab
            event.target.classList.add('active');
            
            // Initialize charts for this tab if needed
            setTimeout(() => {
                if (tabName === 'treatments' && !charts.treatmentChart) {
                    initializeTreatmentCharts();
                } else if (tabName === 'healthcare' && !charts.healthcareChart) {
                    initializeHealthcareChart();
                } else if (tabName === 'demographics') {
                    // Always try to initialize demographics when tab is clicked
                    console.log('Demographics tab clicked, initializing...');
                    initializeDemographicsChart();
                }
            }, 100);
        }
        
        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Add cache-busting parameter
                const cacheBuster = new Date().getTime();
                const response = await fetch(`dashboard_data.json?v=${cacheBuster}`);
                dashboardData = await response.json();
                console.log('Dashboard data loaded:', dashboardData);
                
                document.getElementById('loading').style.display = 'none';
                updateOverviewStats();
                initializeTreatmentCharts();
                initializeDemographicsChart();
                initializeHealthcareChart();
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                document.getElementById('loading').innerHTML = '<p>Error loading data. Please ensure dashboard_data.json is available.</p>';
            }
        }
        
        function updateOverviewStats() {
            if (!dashboardData) return;
            
            const totalPatients = dashboardData.study_overview.total_patients;
            document.getElementById('stat-patients').textContent = totalPatients.toLocaleString();
            document.getElementById('total-patients').textContent = totalPatients.toLocaleString();
            
            // Populate study locations
            const locationGrid = document.getElementById('location-grid');
            if (locationGrid && dashboardData.study_overview.study_locations) {
                locationGrid.innerHTML = dashboardData.study_overview.study_locations
                    .map(location => `<div class="location-item">${location}</div>`)
                    .join('');
            }
        }
        
        function getFilteredData() {
            if (!dashboardData || !dashboardData.treatment_outcomes) return null;
            
            const outcomes = dashboardData.treatment_outcomes;
            let timepoints = Object.keys(outcomes).sort();
            
            // Apply timepoint filter
            if (currentFilters.timepoint !== 'all') {
                timepoints = timepoints.filter(tp => tp === currentFilters.timepoint);
            }
            
            return { outcomes, timepoints };
        }
        
        function initializeTreatmentCharts() {
            const filteredData = getFilteredData();
            if (!filteredData) return;
            
            const { outcomes, timepoints } = filteredData;
            
            // Treatment adherence chart
            const ctx1 = document.getElementById('treatmentChart');
            if (ctx1 && !charts.treatmentChart) {
                // Create datasets based on medication filter
                let datasets = [];
                
                if (currentFilters.medication === 'all' || currentFilters.medication === 'buprenorphine') {
                    datasets.push({
                        label: 'Buprenorphine (%)',
                        data: timepoints.map(tp => outcomes[tp].bup_rate),
                        borderColor: '#4caf50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4
                    });
                }
                
                if (currentFilters.medication === 'all' || currentFilters.medication === 'methadone') {
                    datasets.push({
                        label: 'Methadone (%)',
                        data: timepoints.map(tp => outcomes[tp].mmt_rate),
                        borderColor: '#2196f3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        tension: 0.4
                    });
                }
                
                if (currentFilters.medication === 'all' || currentFilters.medication === 'naltrexone') {
                    datasets.push({
                        label: 'Naltrexone (%)',
                        data: timepoints.map(tp => outcomes[tp].ntx_rate),
                        borderColor: '#ff9800',
                        backgroundColor: 'rgba(255, 152, 0, 0.1)',
                        tension: 0.4
                    });
                }
                
                // Add proper date labels
                const dateLabels = timepoints.map(tp => {
                    const timeInfo = dashboardData.study_overview.timepoints[tp];
                    return timeInfo ? timeInfo.label : tp.replace('_', '-').toUpperCase();
                });
                
                charts.treatmentChart = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: dateLabels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: currentFilters.timepoint === 'all' ? 
                                    'MOUD Treatment Adherence Over Time (March 2018 - May 2021)' : 
                                    `Treatment Adherence at ${dateLabels[0]}`
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Opioid use chart
            const ctx2 = document.getElementById('opioidUseChart');
            if (ctx2 && !charts.opioidUseChart) {
                charts.opioidUseChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: timepoints.map(tp => tp.replace('_', '-').toUpperCase()),
                        datasets: [{
                            label: 'Opioid Use (Past 30 Days) %',
                            data: timepoints.map(tp => outcomes[tp].opioid_rate),
                            backgroundColor: 'rgba(244, 67, 54, 0.7)',
                            borderColor: '#f44336',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Opioid Use Reduction Over Time'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
        
        function initializeHealthcareChart() {
            if (!dashboardData || !dashboardData.healthcare_utilization) return;
            
            const utilization = dashboardData.healthcare_utilization;
            const timepoints = Object.keys(utilization).sort();
            
            const ctx = document.getElementById('healthcareChart');
            if (ctx && !charts.healthcareChart) {
                charts.healthcareChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: timepoints.map(tp => tp.replace('_', '-').toUpperCase()),
                        datasets: [
                            {
                                label: 'Avg. ED Visits',
                                data: timepoints.map(tp => utilization[tp].avg_ed_visits || 0),
                                borderColor: '#f44336',
                                backgroundColor: 'rgba(244, 67, 54, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Avg. Hospital Stays',
                                data: timepoints.map(tp => utilization[tp].avg_hospital_stays || 0),
                                borderColor: '#9c27b0',
                                backgroundColor: 'rgba(156, 39, 176, 0.1)',
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Healthcare Utilization Patterns'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }
        
        function initializeDemographicsChart() {
            console.log('Initializing demographics display...');
            
            if (!dashboardData || !dashboardData.demographics) {
                console.error('No demographics data available');
                document.getElementById('demographics-summary').innerHTML = '<p>Demographics data is loading...</p>';
                return;
            }
            
            const demographics = dashboardData.demographics;
            console.log('Demographics data found:', demographics);
            
            // Always populate the summary first
            populateDemographicsSummary(demographics);
            
            // Try to create chart if possible
            const ctx = document.getElementById('demographicsChart');
            if (ctx && !charts.demographicsChart && demographics.sex) {
                try {
                    const sexData = demographics.sex;
                    charts.demographicsChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(sexData),
                            datasets: [{
                                label: 'Gender Distribution',
                                data: Object.values(sexData),
                                backgroundColor: ['#4caf50', '#2196f3', '#ff9800']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Gender Distribution'
                                }
                            }
                        }
                    });
                    console.log('Demographics chart created');
                } catch (error) {
                    console.error('Chart creation failed:', error);
                    // Hide the canvas if chart fails
                    ctx.style.display = 'none';
                }
            }
        }
        
        function populateDemographicsSummary(demographics) {
            console.log('Populating demographics summary...');
            
            const summaryDiv = document.getElementById('demographics-summary');
            if (!summaryDiv) {
                console.error('Demographics summary div not found');
                return;
            }
            
            let html = `<h4>Study Participants: ${demographics.total_patients.toLocaleString()}</h4>`;
            
            // Gender/Sex
            if (demographics.sex && Object.keys(demographics.sex).length > 0) {
                html += '<div class="info-box"><h4>👥 Gender Distribution</h4><ul>';
                Object.entries(demographics.sex).forEach(([gender, count]) => {
                    const percent = ((count / demographics.total_patients) * 100).toFixed(1);
                    html += `<li><strong>${gender}:</strong> ${count.toLocaleString()} (${percent}%)</li>`;
                });
                html += '</ul></div>';
            }
            
            // Age Categories
            if (demographics.age_categories && Object.keys(demographics.age_categories).length > 0) {
                html += '<div class="info-box"><h4>📊 Age Distribution</h4><ul>';
                Object.entries(demographics.age_categories)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([age, count]) => {
                        const percent = ((count / demographics.total_patients) * 100).toFixed(1);
                        html += `<li><strong>Ages ${age}:</strong> ${count.toLocaleString()} (${percent}%)</li>`;
                    });
                html += '</ul></div>';
            }
            
            // Race/Ethnicity
            if (demographics.race_ethnicity && Object.keys(demographics.race_ethnicity).length > 0) {
                html += '<div class="info-box"><h4>🌍 Race/Ethnicity</h4><ul>';
                Object.entries(demographics.race_ethnicity)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([race, count]) => {
                        const percent = ((count / demographics.total_patients) * 100).toFixed(1);
                        html += `<li><strong>${race}:</strong> ${count.toLocaleString()} (${percent}%)</li>`;
                    });
                html += '</ul></div>';
            }
            
            // Education
            if (demographics.education && Object.keys(demographics.education).length > 0) {
                html += '<div class="info-box"><h4>🎓 Education Level</h4><ul>';
                Object.entries(demographics.education)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([edu, count]) => {
                        const percent = ((count / demographics.total_patients) * 100).toFixed(1);
                        html += `<li><strong>${edu}:</strong> ${count.toLocaleString()} (${percent}%)</li>`;
                    });
                html += '</ul></div>';
            }
            
            summaryDiv.innerHTML = html;
            console.log('Demographics summary populated successfully');
        }
        
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
        });
    </script>
</body>
</html>